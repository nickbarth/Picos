pico-8 cartridge // http://www.pico-8.com
version 16
__lua__

-- globals
player = {}
foot = {}
actors = {}
debug = ""

-- movement
function movement(self)
  self.x += self.dx
  self.y += self.dy
  self.dx += self.ddx
  self.dy += self.ddy

  -- drag friction
  if self.ddx == 0 then
    self.dx *= 0.8
  end

  if self.ddy == 0 then
    self.dy *= 0.8
  end

  -- max speed
  if self.dx > 3 then self.dx = 3 end
  if self.dx < -3 then self.dx = -3 end
  if self.dy > 3 then self.dy = 3 end
  if self.dy < -3 then self.dy = -3 end

  -- bounds
  if self.x < 1 then
    self.x = 1
    self.dx = 0
  end

  if self.x > 55 then
    self.x = 55
    self.dx = 0
  end

  if self.y < 0 then
    self.y = 0
    self.dy = 0
  end

  if self.y > 55 then
    self.y = 55
    self.dy = 0
  end

  -- reset
  self.ddx = 0
  self.ddy = 0
end

-- sprite
function make_sprite(x, y, frame)
  local self = {}
  self.x = x or 0
  self.y = y or 0
  self.dx = 0
  self.dy = 0
  self.frame = frame
  self.cframe = 0
  self.step = 0
  self.ddx = 0
  self.ddy = 0

  -- state
  self.alive = true
  self.forward = true

  -- update
  function self.update()
  end

  -- draw
  function self.draw(self, layer)
    if layer == 1 then
      local frame = self.cframe + self.frame
      spr(frame, self.x, self.y, 1, 1, not self.forward, false)
    end
  end

  function self.animate(self, frames, speed)
    if self.step % speed == 0 and (self.dx or self.dy) then
      self.cframe = (self.cframe + 1) % frames
    end
  end

  return self
end

-- player
function make_crab(x, y)
  local self = make_sprite(x, y, 1)

  -- player input
  function self.controls()
    if btn(0) then -- left
      self.forward = false
      self.ddx -= 0.25
    end

    if btn(1) then -- right
      self.forward = true
      self.ddx += 0.25
    end

    if btn(2) then -- up
      self.ddy -= 0.25
    end

    if btn(3) then -- down
      self.ddy += 0.25
    end
  end

  -- update
  function self.update()
    self.step += 1

    self:controls()
    movement(self)
    self:animate(2, 8)

    debug = self.frame .. " " .. self.cframe
  end

  return self
end

-- enemy
function make_foot(x, y)
  local self = make_sprite(x, y)

  -- state
  self.target = { x=20, y=50 }

  function self.update()
    local target = self.target

    if (self.y + 28) < target.y then
      self.dy += 0.50
    else
      self.y -= 50
    end

    movement(self)
  end

  function self.draw(self, layer)
    local target = self.target

    if layer == 1 then
      spr(4, self.x, self.y, 3, 3, not self.forward, false) -- foot
    end

    if layer == 0 then
      spr(51, target.x, target.y, 3, 1, not self.forward, false) -- shadow
    end
  end

  return self
end

function _init()
  poke(0x5f2c, 3)

  player = make_crab(0, 0, 1)
  foot = make_foot(20, 0, 1)
end

function _update()
  player:update()
  foot:update()
end

function _draw()
  cls(7)
  map(0, 0, 0, 0, 8, 8)

  for layer=0,3,1 do
    player:draw(layer)
    foot:draw(layer)
  end

  print(debug, 1, 1, 0)
end

__gfx__
000000000000000000000000000000000000000000000eeee000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
00000000808008088800008800000000000000000000eeeeee00000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
00700700888008888800008800000000000000000000eeeeee00000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
00077000800000088000000800000000000000000000eeeeee00000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
00077000808888088088880800000000000000000000eeeeee00000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
00700700808282088082820800000000000000000000eeeeee00000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
00000000888888888888888800000000000000000000eeeeee00000000000000ffffffffffffffffffffffffffffffffffffffffffffff999999999fffff99ff
00000000008008000008800000000000000000000000eeeeee00000000000000fffffffffffffffffffffffffffffffffffffffffff999fffffffff99999ffff
00000000000000000000000000000000000000000000eeeeee00000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
00000000000000000000000000000000000000000000eeeeee00000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
82800000000008280000000000000000000000000000eeeeee00000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
82808880088808280000000000000000000000000000eeeeee00000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
82808778877808280000000000000000000000000000eeeeee00000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
82808008800808280000000000000000000000000000eeeeee00000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
88808888888808880000000000000000000000000000eeeeee00000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
08208888888800280000000000000000000000000000eeeeee00000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
08208222222800280000000000000000000000000000eeeeee00000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
08208288882800280000000000000000000000000000eeeeee00000000000000ffffff99999999ffffffffffffffffffffffffffffffffffffffffffffffffff
0888828888288888000000000000000000000000000eeeeeee00000000000000ffffffffffffff99ffffffffffffffffffffffffffffffffffffffffffffffff
00008888888800000000000000000000000000000eeeeeeeee00000000000000ffffffffffffffff9999999fffffffffffffffffffffffffffffffffffffffff
000822000022800000000000000000000777eeeeeeeeeeeeee00000000000000fffffffffffffffffffffffffffffffffffffffffff999ffffffffffffffffff
00882000000288000000000000000000eeeeeeeeeeeeeeeeee00000000000000fffffffffffffffffffffffffffffffffffffffff99fff99999999999fffffff
00000000000000000000000000000000eeeeeeeeeeeeeeeeee00000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
000000000000000000000000000000000eeeeeeeeeee00eee000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
0000000000000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
0000000000000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
0000000000000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
0000000000000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
0555555005555555500000000555555555555555500000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
5555555555555555550000005555555555555555550000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
5555555555555555550000005555555555555555550000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
0555555005555555500000000555555555555555500000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
0000000000000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
0000000000000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
8280000000000828000000000000000000000000000000000000000000000000ffffffffffffffffffff99999999ffffffffffffffffffffffffffffffffffff
8280888008880828000000000000000000000000000000000000000000000000fffffffffffffff99999ffffffffffffffffffffffffffffffffffffffffffff
8280877887780828000000000000000000000000000000000000000000000000fffffffffffff99fffffffffffffffffffffffffffffffffffffffffffffffff
8280800880080828000000000000000000000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
8880888888880888000000000000000000000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
0820888888880028000000000000000000000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
0820822222280028000000000000000000000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
0820828888280028000000000000000000000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
0888828888288888000000000000000000000000000000000000000000000000fffffffffffffffffffffffffffffffffffffffffffffffffffffffffff99fff
0000888888880000000000000000000000000000000000000000000000000000fffffffffffffffffffffffffffffffffffffffff9999999999fffff999fffff
0008220000228000000000000000000000000000000000000000000000000000fffffffffffffffffffffffffffffffffffffffffffffffffff99999ffffffff
0088200000028800000000000000000000000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
0000000000000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
0000000000000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
0000000000000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
0000000000000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
0000000000000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
0000000000000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
0000000000000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
0000000000000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
0000000000000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
0000000000000000000000000000000000000000000000000000000000000000fffffff99fffffffffffffffffffffffffffffffffffffffffffffffffffffff
0000000000000000000000000000000000000000000000000000000000000000fffff99ff9999fffffffffffffffffffffffffffffffffffffffffffffffffff
0000000000000000000000000000000000000000000000000000000000000000fffffffffffff999ffffffffffffffffffffffffffffffffffffffffffffffff
0000000000000000000000000000000000000000000000000000000000000000ffffffffffffffff9fffffff999fffffffffffffffffffffffffffffffffffff
0000000000000000000000000000000000000000000000000000000000000000fffffffffffffffff9999999ffffffffffffffffffffffffffffffffffffffff
0000000000000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
0000000000000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
0000000000000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
0000000000000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
__map__
08090a0b0c0d0e0f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
18191a1b1c1d1e1f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
28292a2b2c2d2e2f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
38393a3b3c3d3e3f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
48494a4b4c4d4e4f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
58595a5b5c5d5e5f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
68696a6b6c6d6e6f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
78797a7b7c7d7e7f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
